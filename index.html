<!DOCTYPE html>
<html>
<head>
    <title>CLSI Breakpoint Finder with Pyodide</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.18.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script>
        async function loadPyodideAndPackages() {
            window.pyodide = await loadPyodide();
            await pyodide.loadPackage(['micropip', 'sqlite3']);
            console.log("Pyodide loaded successfully.");
        }

        window.onload = async () => {
            await loadPyodideAndPackages();
        };

        // Handle form submission
        async function getBreakpoint() {
            const organismInput = document.getElementById("organism").value.trim();
            const antimicrobialInput = document.getElementById("antimicrobial").value.trim();

            // Python script to query database
            const pythonCode = `
import sqlite3

# Connect to the SQLite database (assuming it is stored locally)
connection = sqlite3.connect('breakpoints.db')
cursor = connection.cursor()

# Define the query
query = "SELECT * FROM breakpoints WHERE organism LIKE ? AND antimicrobial LIKE ?"

# Parameters for the query
parameters = (
    f"%{organismInput}%" if organismInput else "%",
    f"%{antimicrobialInput}%" if antimicrobialInput else "%"
)

# Execute the query
cursor.execute(query, parameters)
results = cursor.fetchall()

# Close connection
connection.close()

# Format the results
formatted_results = ""
for row in results:
    formatted_results += f"{row[0]} - {row[1]}: {row[2]}<br>"

formatted_results
`;

            try {
                // Run the Python code using Pyodide
                let result = await pyodide.runPythonAsync(pythonCode);
                document.getElementById("result").innerHTML = result || "No data found for the given input.";
            } catch (error) {
                console.error("Error executing Python code:", error);
                document.getElementById("result").innerHTML = "An error occurred. Please try again.";
            }
        }
    </script>
</head>
<body>
    <h1>CLSI Breakpoint Finder with Pyodide</h1>
    <form onsubmit="event.preventDefault(); getBreakpoint();">
        <label for="organism">Enter Organism:</label>
        <input type="text" id="organism" name="organism" placeholder="e.g. E. coli"><br><br>
        <label for="antimicrobial">Enter Antimicrobial (leave blank for all):</label>
        <input type="text" id="antimicrobial" name="antimicrobial" placeholder="e.g. Cefepime"><br><br>
        <input type="submit" value="Get Breakpoint">
    </form>

    <h3>Result:</h3>
    <p id="result"></p>
</body>
</html>
