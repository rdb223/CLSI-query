<!DOCTYPE html>
<html>
<head>
    <title>CLSI Breakpoint Finder</title>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script>
        let breakpoints = [];

        // Load the breakpoint data from JSON
        async function loadBreakpoints() {
            try {
                const response = await fetch('breakpoints.json');
                breakpoints = await response.json();
                console.log("Breakpoints data loaded successfully:", breakpoints);
            } catch (error) {
                console.error("Error loading JSON data:", error);
            }
        }

        // Function to get closest match using Fuse.js
        function getClosestMatches(input, options, keys) {
            const fuse = new Fuse(options, { keys: keys, threshold: 0.3 });
            const results = fuse.search(input);
            console.log("Fuzzy search results for input:", input, results);
            return results.map(result => result.item);
        }

        // Handle form submission
        async function getBreakpoint() {
            const organismInput = document.getElementById("organism").value.trim();
            const antimicrobialInput = document.getElementById("antimicrobial").value.trim();

            let selectedOrganism = null;
            let selectedAntimicrobial = null;

            // Fuzzy match organisms
            if (organismInput) {
                const organismMatches = getClosestMatches(organismInput, breakpoints, ['organism']);
                if (organismMatches.length) {
                    selectedOrganism = organismMatches[0].organism;
                    console.log("Selected Organism:", selectedOrganism);
                } else {
                    console.log("No match found for organism input:", organismInput);
                }
            }

            // Fuzzy match antimicrobials
            if (antimicrobialInput) {
                const antimicrobialMatches = getClosestMatches(antimicrobialInput, breakpoints, ['antimicrobial']);
                if (antimicrobialMatches.length) {
                    selectedAntimicrobial = antimicrobialMatches[0].antimicrobial;
                    console.log("Selected Antimicrobial:", selectedAntimicrobial);
                } else {
                    console.log("No match found for antimicrobial input:", antimicrobialInput);
                }
            }

            // Find breakpoints based on selected organism and antimicrobial
            let result = "No data found for the given input.";

            if (selectedOrganism) {
                const filteredBreakpoints = breakpoints.filter(bp => bp.organism.toLowerCase() === selectedOrganism.toLowerCase());
                
                if (selectedAntimicrobial) {
                    const specificResult = filteredBreakpoints.find(bp => bp.antimicrobial.toLowerCase() === selectedAntimicrobial.toLowerCase());
                    if (specificResult) {
                        result = `The breakpoint for ${selectedOrganism} with ${selectedAntimicrobial} is: ${specificResult.breakpoint}`;
                    } else {
                        result = `No breakpoint found for ${selectedOrganism} with ${selectedAntimicrobial}.`;
                    }
                } else {
                    result = `Available breakpoints for ${selectedOrganism}:<br>`;
                    filteredBreakpoints.forEach(bp => {
                        result += `${bp.antimicrobial}: ${bp.breakpoint}<br>`;
                    });
                }
            } else if (selectedAntimicrobial) {
                // If only antimicrobial is entered, display organisms related to that antimicrobial
                const filteredBreakpoints = breakpoints.filter(bp => bp.antimicrobial.toLowerCase() === selectedAntimicrobial.toLowerCase());
                
                if (filteredBreakpoints.length) {
                    result = `Available breakpoints for ${selectedAntimicrobial}:<br>`;
                    filteredBreakpoints.forEach(bp => {
                        result += `${bp.organism}: ${bp.breakpoint}<br>`;
                    });
                } else {
                    result = `No data found for antimicrobial ${selectedAntimicrobial}.`;
                }
            }

            console.log("Final result:", result);
            document.getElementById("result").innerHTML = result;
        }

        window.onload = loadBreakpoints;
    </script>
</head>
<body>
    <h1>CLSI Breakpoint Finder</h1>
    <form onsubmit="event.preventDefault(); getBreakpoint();">
        <label for="organism">Enter Organism:</label>
        <input type="text" id="organism" name="organism" placeholder="e.g. E. coli"><br><br>
        <label for="antimicrobial">Enter Antimicrobial (leave blank for all):</label>
        <input type="text" id="antimicrobial" name="antimicrobial" placeholder="e.g. Cefepime"><br><br>
        <input type="submit" value="Get Breakpoint">
    </form>

    <h3>Result:</h3>
    <p id="result"></p>
</body>
</html>
