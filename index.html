<!DOCTYPE html>
<html>
<head>
    <title>CLSI Breakpoint Finder</title>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script>
        let breakpoints = [];

        // Load the breakpoint data from JSON
        async function loadBreakpoints() {
            try {
                const response = await fetch('breakpoints.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                breakpoints = await response.json();
                console.log("Breakpoints data loaded successfully:", breakpoints);
            } catch (error) {
                console.error("Error loading JSON data:", error);
                document.getElementById("result").innerHTML = "Error loading breakpoint data. Please try again later.";
            }
        }

        // Function to get closest match using Fuse.js
        function getClosestMatches(input, options, keys) {
            const fuse = new Fuse(options, { keys: keys, threshold: 0.3 });
            const results = fuse.search(input);
            console.log("Fuzzy search results for input:", input, results);
            return results.map(result => result.item);
        }

        // Handle form submission
        function getBreakpoint() {
            const organismInput = document.getElementById("organism").value.trim();
            const antimicrobialInput = document.getElementById("antimicrobial").value.trim();

            if (!breakpoints || breakpoints.length === 0) {
                document.getElementById("result").innerHTML = "Breakpoint data not loaded. Please wait or try reloading the page.";
                return;
            }

            let filteredBreakpoints = breakpoints;

            // Filter by organism if input is provided
            if (organismInput) {
                const organismMatches = getClosestMatches(organismInput, breakpoints, ['organism']);
                if (organismMatches.length) {
                    filteredBreakpoints = organismMatches;
                } else {
                    document.getElementById("result").innerHTML = `No match found for organism: ${organismInput}`;
                    return;
                }
            }

            // Further filter by antimicrobial if input is provided
            if (antimicrobialInput) {
                const antimicrobialMatches = getClosestMatches(antimicrobialInput, filteredBreakpoints, ['antimicrobial']);
                if (antimicrobialMatches.length) {
                    filteredBreakpoints = antimicrobialMatches;
                } else {
                    document.getElementById("result").innerHTML = `No match found for antimicrobial: ${antimicrobialInput}`;
                    return;
                }
            }

            // Display the results
            if (filteredBreakpoints.length > 0) {
                let result = "Available breakpoints:<br>";
                filteredBreakpoints.forEach(bp => {
                    result += `${bp.organism} - ${bp.antimicrobial}: ${bp.breakpoint}<br>`;
                });
                document.getElementById("result").innerHTML = result;
            } else {
                document.getElementById("result").innerHTML = "No data found for the given input.";
            }
        }

        window.onload = loadBreakpoints;
    </script>
</head>
<body>
    <h1>CLSI Breakpoint Finder</h1>
    <form onsubmit="event.preventDefault(); getBreakpoint();">
        <label for="organism">Enter Organism:</label>
        <input type="text" id="organism" name="organism" placeholder="e.g. E. coli"><br><br>
        <label for="antimicrobial">Enter Antimicrobial (leave blank for all):</label>
        <input type="text" id="antimicrobial" name="antimicrobial" placeholder="e.g. Cefepime"><br><br>
        <input type="submit" value="Get Breakpoint">
    </form>

    <h3>Result:</h3>
    <p id="result"></p>
</body>
</html>
